/*
	iio engine
	Version 1.3.3 Beta
	Last Update 8/19/2014

	1.3 is a work in progress, but already useful for many apps
	1.2 has more features, less bugs, and is available on github

	API: iioengine.com/api
	Demos: iioapps.com
	Sandbox: iioengine.com/sandbox 
	Offline versions are included in the github repository

---------------------------------------------------------------------
The iio Engine is licensed under the BSD 2-clause Open Source license

Copyright (c) 2014, Sebastian Bierman-Lytle
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, 
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list 
of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other 
materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT 
NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, 
OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
POSSIBILITY OF SUCH DAMAGE.
*/
iio={},function(){function i(){}function t(){this.App.apply(this,arguments)}function e(){this.SpriteMap.apply(this,arguments)}function s(){this.Obj.apply(this,arguments)}iio.APP="App",iio.OBJ="Obj",iio.LINE="Line",iio.CIRC="Ellipse",iio.RECT="Rectangle",iio.POLY="Polygon",iio.GRID="Grid",iio.TEXT="Text",Array.prototype.insert=function(i,t){return this.splice(i,0,t),this},iio.inherit=function(t,e){var s=t;i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=s},iio.isNumber=function(i){return!isNaN(i-0)&&null!==i&&""!==i&&i!==!1&&i!==!0},iio.isString=function(i){return"string"==typeof i||i instanceof String},iio.isBetween=function(i,t,e){if(t>e){var s=t;t=e,e=s}return i>=t&&e>=i},iio.isImage=function(i){for(var t=["png","jpg","gif","tiff"],e=0;e<t.length;e++)if(-1!=i.indexOf("."+t[e]))return!0;return!1},iio.isFunction=function(i){var t={};return i&&"[object Function]"===t.toString.call(i)},iio.randomColor=function(){return"rgb("+Math.floor(255*Math.random())+","+Math.floor(255*Math.random())+","+Math.floor(255*Math.random())+")"},iio.random=function(i,t){return i=i||0,t=0===t||"undefined"!=typeof t?t:1,Math.random()*(t-i)+i},iio.randomInt=function(i,t){return i=i||0,t=t||1,Math.floor(Math.random()*(t-i))+i},iio.invertColor=function(i){var t=i.substr(i.indexOf(",")+1),e=t.substr(t.indexOf(",")+1);return"rgb("+(255-parseInt(i.substr(i.indexOf("(")+1,i.indexOf(",")),10))+","+(255-parseInt(t.substr(0,t.indexOf(",")),10))+","+(255-parseInt(e.substr(0,e.indexOf(")")),10))+")"},iio.load=function(i,t){var e=new Image;return e.src=i,e.onload=t,e},iio.pointsToVecs=function(i){var t=[];i instanceof Array||(i=[i]);for(var e=0;e<i.length;e++)"undefined"!=typeof i[e].x?t.push(i[e]):(t.push({x:i[e],y:i[e+1]}),e++);return t},iio.rotatePoint=function(i,t,e){if("undefined"!=typeof i.x&&(e=t,t=i.y,i=i.x),"undefined"==typeof e||0==e)return{x:i,y:t};var s=i*Math.cos(e)-t*Math.sin(e),o=t*Math.cos(e)+i*Math.sin(e);return{x:s,y:o}},iio.addEvent=function(i,t,e,s){return i.addEventListener?(i.addEventListener(t,e,s),!0):i.attachEvent?(i.attachEvent("on"+t,e),!0):!1},iio.read=function(i,t){var e=new XMLHttpRequest;e.open("GET",i,!0),e.onreadystatechange=function(){4!==e.readyState||200!==e.status&&0!=e.status||t(e.responseText)},e.send(null)},iio.getKeyString=function(i){switch(i.keyCode){case 8:return"backspace";case 9:return"tab";case 13:return"enter";case 16:return"shift";case 17:return"ctrl";case 18:return"alt";case 19:return"pause";case 20:return"caps lock";case 27:return"escape";case 32:return"space";case 33:return"page up";case 34:return"page down";case 35:return"end";case 36:return"home";case 37:return"left arrow";case 38:return"up arrow";case 39:return"right arrow";case 40:return"down arrow";case 45:return"insert";case 46:return"delete";case 48:return"0";case 49:return"1";case 50:return"2";case 51:return"3";case 52:return"4";case 53:return"5";case 54:return"6";case 55:return"7";case 56:return"8";case 57:return"9";case 65:return"a";case 66:return"b";case 67:return"c";case 68:return"d";case 69:return"e";case 70:return"f";case 71:return"g";case 72:return"h";case 73:return"i";case 74:return"j";case 75:return"k";case 76:return"l";case 77:return"m";case 78:return"n";case 79:return"o";case 80:return"p";case 81:return"q";case 82:return"r";case 83:return"s";case 84:return"t";case 85:return"u";case 86:return"v";case 87:return"w";case 88:return"x";case 89:return"y";case 90:return"z";case 91:return"left window";case 92:return"right window";case 93:return"select key";case 96:return"n0";case 97:return"n1";case 98:return"n2";case 99:return"n3";case 100:return"n4";case 101:return"n5";case 102:return"n6";case 103:return"n7";case 104:return"n8";case 105:return"n9";case 106:return"multiply";case 107:return"add";case 109:return"subtract";case 110:return"dec";case 111:return"divide";case 112:return"f1";case 113:return"f2";case 114:return"f3";case 115:return"f4";case 116:return"f5";case 117:return"f6";case 118:return"f7";case 119:return"f8";case 120:return"f9";case 121:return"f10";case 122:return"f11";case 123:return"f12";case 144:return"num lock";case 156:return"scroll lock";case 186:return"semi-colon";case 187:return"equal";case 188:return"comma";case 189:return"dash";case 190:return"period";case 191:return"forward slash";case 192:return"grave accent";case 219:return"open bracket";case 220:return"back slash";case 221:return"close bracket";case 222:return"single quote";default:return"undefined"}},iio.keyCodeIs=function(i,t){i instanceof Array||(i=[i]);for(var e=iio.getKeyString(t),s=0;s<i.length;s++)if(e==i[s])return!0;return!1},iio.cancelLoop=function(i){window.clearTimeout(i),window.cancelAnimationFrame(i)},iio.cancelLoops=function(i,t){var e;for(e=0;e<i.loops.length;e++)iio.cancelLoop(i.loops[e].id);if(i.mainLoop&&iio.cancelLoop(i.mainLoop.id),"undefined"==typeof t)for(e=0;e<i.objs.length;e++)iio.cancelLoops(i.objs[e])},iio.loop=function(i,t,e){function s(){var e=(new Date).getTime();if("undefined"==typeof t.last)var o=!0;var n=Math.floor(Math.max(0,1e3/i-(e-(t.last||i))));t.last=e+n;var r;"undefined"==typeof o&&(r="undefined"==typeof t.fn?t.o._update(t.o,n):iio.isFunction(t.fn)?t.fn(t.o,t,n):t.fn._update(t,n),t.o.draw()),"undefined"==typeof r?t.id=window.setTimeout(s,n):(i=r,t.id=window.setTimeout(s,1e3/r))}function o(){"undefined"==typeof t.fn?t.o.draw():iio.isFunction(t.fn)?t.fn():(t.fn._update(),t.fn.draw()),t.id=window.requestAnimationFrame(o)}return iio.isNumber(i)||"undefined"==typeof window.requestAnimationFrame||!i.af?("undefined"!=typeof i.af&&"undefined"==typeof i.fps?(e=t,t=i,i=60):iio.isNumber(i)||(t=i,i=i.fps),t.id=window.setTimeout(s,1e3/i),t.id):(e=t,t=i,t.id=window.requestAnimationFrame(o),t.id)},iio.resize=function(){for(var i=0;i<iio.apps.length;i++)iio.apps[i].canvas.fullscreen&&(window.jQuery?(iio.apps[i].canvas.width=$(window).width(),iio.apps[i].canvas.height=$(window).height()):(iio.apps[i].canvas.width=window.innerWidth,iio.apps[i].canvas.height=window.innerHeight)),iio.apps[i].width=iio.apps[i].canvas.width,iio.apps[i].height=iio.apps[i].canvas.height,iio.apps[i].center.x=iio.apps[i].canvas.width/2,iio.apps[i].center.y=iio.apps[i].canvas.height/2,iio.apps[i].runScript.resize&&iio.apps[i].runScript.resize(),iio.apps[i].draw()},window.onresize=function(){iio.resize()},iio.apps=[],iio.start=function(i,t,e){var s;return t?(s=document.getElementById(t),s||("CANVAS"==t.tagName?s=t:(iio.isNumber(t)||t.x)&&(s=document.createElement("canvas"),s.width=t.x||t,s.height=t.y||t,e.appendChild(s)))):(document.body.style.margin=0,document.body.style.padding=0,s=document.createElement("canvas"),s.margin=0,s.padding=0,s.style.position="absolute",s.fullscreen=!0,window.jQuery?(s.width=$(document).width(),s.height=$(document).height()):(s.width=window.innerWidth,s.height=window.innerHeight),document.body.appendChild(s)),i instanceof Array?new iio.App(s,i[0],i[1]):iio.isString(i)&&".iio"==i.substring(i.length-4)?iio.read("App.iio",function(i){iio.start(i)}):new iio.App(s,i)},iio.scriptProps=[["app",1],["vel",1],["acc",1],["o",0],["z",1],["round",-1],["outline",2],["grid",3],["rotate",1],["alpha",1],["lineCap",1],["hidden",1],["dash",-1],["bezier",9999999],["shadow",3],["origin",1],["font",1],["simple",0],["x",2],["cursor",0],["open",0]],iio.scriptFns=["add","loop","draw"],iio.operators=["/","%","*","+","-"],iio.scriptConsts=["randomColor"],iio.isKey=function(i,t){for(var e=0;e<i.length;e++)if(i[e]==t)return!0;return!1},iio.isiioProp=function(i){for(var t=0;t<iio.scriptProps.length;t++)if(iio.scriptProps[t][0]==i)return!0;return!1},iio.isColor=function(i){for(var t=0;t<iio.operators.length;t++)if(i.indexOf(iio.operators[t])>-1)return!1;return iio.isNumber(i)||i.indexOf(":")>-1||i.indexOf("px")>-1||"width"==i||"height"==i||"center"==i?!1:!0},iio.takesOther=function(i){return"outline"==i||"color"==i||"shadow"==i||"app"==i||"hidden"==i||"grid"==i||"x"==i||"font"==i?!0:!1},iio.maxParams=function(i){for(var t=0;t<iio.scriptProps.length;t++)if(iio.scriptProps[t][0]==i)return iio.scriptProps[t][1];return-1},iio.indexOfiioDelineator=function(i){var t=i.indexOf(":");return i.indexOf("http://")==t-4&&(t=-1),t},iio.parsePos=function(i,t){for(var e=0,s=[],o=iio.indexOfiioDelineator(i[e]);-1==i[e].indexOf("gradient")&&o>-1&&o<i[e].length-1||"center"==i[e];)"center"==i[e]?s.push(t.type==iio.APP?t.eval("center"):{x:0,y:0}):(s.push(t.eval(i[e].substring(0,o))),s.push(t.eval(i[e].substring(o+1)))),e++,o=iio.indexOfiioDelineator(i[e]);0==s.length&&(s[0]={x:0,y:0}),i.splice(0,e),e=1;for(var n=i[0];e<i.length;)n+=" "+i[e++];return{ps:s,p:n}},iio.runiioFn=function(i,t){if("loop"==i[0]){var e;iio.isNumber(i[1])?(e=i.slice().splice(2,i.length),t.loop(i[1],function(){iio.run(e.slice(),t),t.draw()})):(e=i.slice().splice(1,i.length),t.loop(function(){iio.run(e.slice(),t),t.draw()}))}else{if("add"==i[0]){var s=iio.parsePos(i.splice(1),t);return t.add(s.ps,s.p)}"draw"==i[0]&&t.app.draw()}},iio.runiioProp=function(i,t){if("app"==t[0]){var e;if(i.type!=iio.APP)for(var e=i.parent;e.type!=iio.APP;)e=e.parent;else e=i;t[1]&&iio.run([t[1]],e,!0)}else if("rotate"==t[0])i.rot+=i.eval(t[1]);else if("vel"==t[0]||"acc"==t[0]){var s=t[1].split(":");"vel"==t[0]?(i.vel.x=i.eval(s[0]),i.vel.y=i.eval(s[1]),i.vel.r=i.eval(s[2])):(i.acc.x=i.eval(s[0]),i.acc.y=i.eval(s[1]),i.acc.r=i.eval(s[2]))}else if("o"==t[0])i.type=iio.CIRC;else if("z"==t[0])i.z=parseFloat(t[1]);else if("hidden"==t[0])i.hidden=t[1]&&"false"==t[1]?!1:!0;else if("round"==t[0])if(i.type==iio.APP){i.round=t[1];for(var o=2;o<t.length;o++)i.round+=" "+t[o]}else i.round=2==t.length?[t[1],t[1],t[1],t[1]]:3==t.length?[t[1],t[2],t[1],t[2]]:[t[1],t[2],t[3],t[4]];else if("outline"==t[0])for(var o=1;o<t.length;o++)iio.isNumber(t[o].substring(0,1))||"-"==t[o].substring(0,1)?i.lineWidth=i.eval(t[o]):i.outline="randomColor"==t[o]?iio.randomColor():t[o];else if("alpha"==t[0])i.alpha=t[1];else if("lineCap"==t[0])i.lineCap=t[1];else if("shadow"==t[0]){i.shadow=t[1];for(var o=2;o<t.length;o++)i.shadow+=" "+t[o]}else if("origin"==t[0])if("center"==t[1])i.origin=i.center;else{var s=t[1].split(":");i.origin={x:s[0],y:s[1],r:s[2]}}else if("dash"==t[0]){for(var n=1;n<t.length;n++)t[n]=i.eval(t[n]);i.dash=t.splice(1,t.length)}else if("bezier"==t[0]){for(var n=1;n<t.length;n++)t[n]=i.parent.eval(t[n]);i.bezier=t.splice(1,t.length)}else if("grid"==t[0]){i.type=iio.GRID;for(var n=1;n<t.length;n++){var r=t[n].indexOf(":");if(0>r){var s=i.eval(t[n]);iio.isString(s)?i.gridColor=s:(i.C=s,i.R=i.C)}else{var h=t[n].split(":");i.C=h[0],i.R=h[1]}i.res={x:i.width/i.C,y:i.height/i.R}}}else if("x"==t[0])if(1==t.length)i.xColor=i.color||i.outline;else for(var n=1;n<t.length;n++)iio.isNumber(t[n])?i.lineWidth=i.eval(t[n]):i.xColor=i.eval(t[n]);else"font"==t[0]?i.font=t[1]:"simple"==t[0]?i.simple=!0:"cursor"==t[0]?i.showCursor=!0:"open"==t[0]&&(i.open=!0)},iio.runiioConst=function(i,t){var e=iio.indexOfiioDelineator(t),s=t.indexOf("gradient");e>-1&&-1==s?(e>0&&(i.width=i.parent.eval(t.substring(0,e))),i.height=e+1<t.length?i.parent.eval(t.substring(e+1)):i.width,i.center.x=i.pos.x,i.center.y=i.pos.y):"randomColor"==t?i.color=iio.randomColor():iio.isNumber(t.substring(0,1))?i.type==iio.LINE?i.lineWidth=i.eval(t):i.width=i.height=i.eval(t):iio.isImage(t)?i.img=t:"center"==t||"left"==t||"right"==t||"end"==t?i.align=t:""!=t&&(i.color=t)},iio.run=function(i,t){var e;if(i instanceof Array)for(;i.length>0;)if(iio.isKey(iio.scriptFns,i[0])){for(var s=-1,o=0;o<i.length;o++)"|"==i[o]&&(s=o);-1==s?(e=iio.runiioFn(i.slice(),t),s=i.length):e=iio.runiioFn(i.slice().splice(0,s),t),i=i.splice(s+1,i.length)}else if(iio.isiioProp(i[0])){var n,r,h=0;for(n=[],n[0]=i[h],r=iio.maxParams(i[h++]);i[h]&&"|"!=i[h]&&(iio.takesOther(i[0])||!iio.isColor(i[h])||"n"==i[h])&&(!iio.isiioProp(i[h])||"round"==i[h]&&"lineCap"==i[0]||"origin"==i[0]&&"center"==i[h])&&("app"==i[0]||!iio.isKey(iio.scriptFns,i[h]))&&(r>=h||-1==r);)n.push(i[h++]);iio.runiioProp(t,n.slice()),i=i.splice(h)}else if('"'==i[0].charAt(0)||"'"==i[0].charAt(0)){var a=i[0].charAt(0),r=0;if(i[r].charAt(i[r].length-1)==a)t.text=i[r].substring(1,i[r].length-1);else{for(var p=i[0].substring(1),r=1;r<i.length&&i[r].charAt(i[r].length-1)!=a;)p+=" "+i[r],r++;t.text=p+" "+i[r].substring(0,i[r].length-1)}i=i.splice(r+1)}else if("if"==i[0]){for(var l=-1,p=-1,o=0;o<i.length;o++)"else"==i[o]&&(l=o);for(var o=0;o<i.length;o++)"then"==i[o]&&(p=o);t.eval(i[1])?l>-1?iio.run(i.slice().splice(2,l-2),t,!0):p>-1?iio.run(i.slice().splice(2,p-2),t,!0):iio.run(i.slice().splice(2,i.length),t,!0):-1!=l&&(p>-1?iio.run(i.slice().splice(l+1,p-l-1),t,!0):iio.run(i.slice().splice(l+1,i.length),t,!0)),i=p>-1?i.splice(p+1,i.length):[]}else"!"==i[0].substring(0,1)?(i[0]=i[0].substring(1),"hidden"==i[0]&&(t.hidden=!t.hidden,i=i.splice(1,i.length))):(iio.runiioConst(t,i[0]),i=i.splice(1));else if(iio.isString(i))e=iio.run(i.split(" "),t);else for(var r=0;r<t.length;r++)iio.isNumber(t[r])?i.lineWidth=i.eval(t[r]):i.color=t[r];return e},init=function(){this.scale=1,this.objs=[],this.set=set,this.add=add,this.rmv=rmv,this.rqAnimFrame=!0,this.partialPx=!0,this.alpha=1,this.loops=[],this.run=function(i,t){return iio.run(i,this,t)},this.loop=function(i,t){this.looping=!0;var e;return"undefined"==typeof t?"undefined"==typeof i?(this.app.mainLoop&&iio.cancelLoop(this.app.mainLoop.id),e=this.app.mainLoop={fps:60,fn:this,af:this.rqAnimFrame,o:this.app},this.app.fps=60,e.id=this.app.mainLoop.id=iio.loop(this.app.mainLoop)):iio.isNumber(i)?(this.app.mainLoop&&iio.cancelLoop(this.app.mainLoop.id),e=this.app.mainLoop={fps:i,o:this.app,af:!1},this.app.fps=i,e.id=this.app.mainLoop.id=iio.loop(this.app.mainLoop)):(e={fps:60,fn:i,af:this.rqAnimFrame},e.id=iio.loop(e,i)):(e={fps:i,fn:t,o:this,af:this.rqAnimFrame},e.id=iio.loop(i,e,t)),this.loops.push(e),e.id},this.clearLoops=function(){for(var i=0;i<this.loops.length;i++)iio.cancelLoop},this.pause=function(i){if(this.paused){this.paused=!1;for(var t=0;t<this.loops.length;t++)iio.loop(this.loops[t]);if(this.mainLoop&&iio.loop(this.mainLoop),"undefined"==typeof i)for(var t=0;t<this.objs.length;t++)for(var e=0;e<this.objs[t].loops.length;e++)iio.loop(this.objs[t].loops[e])}else iio.cancelLoops(this),iio.cancelLoop(this.mainLoop.id),this.paused=!0},this.playAnim=function(i,t,e,s,o){if(iio.isString(t)){for(var n=0;n<this.anims.length;n++)if(this.anims[n].tag==t){this.animKey=n,this.width=this.anims[n].frames[this.animFrame].w,this.height=this.anims[n].frames[this.animFrame].h;break}}else e=t;this.animFrame=o||0,"undefined"!=typeof e&&(this.repeat=e,this.onanimstop=s),forward=function(i){if(i.animFrame++,i.animFrame>=i.anims[i.animKey].frames.length&&(i.animFrame=0,"undefined"!=typeof i.repeat)){if(i.repeat<=1)return window.cancelAnimationFrame(id),window.clearTimeout(id),void(i.onanimstop&&i.onanimstop(id,i));i.repeat--}},backward=function(i){i.animFrame--,i.animFrame<0&&(i.animFrame=i.anims[i.animKey].frames.length-1),i.app.draw()};var r;return i>0?r=this.loop(i,forward):0>i?r=this.loop(-1*i,backward):this.app.draw(),r},this.eval=function(i){if(!i)return 0;if(iio.isNumber(i))return parseFloat(i);if("center"==i)return this.center;if("width"==i)return this.width;if("height"==i)return this.height;if("hidden"==i)return this.hidden;if("random"==i)return iio.random();if("randomColor"==i)return iio.randomColor();var t;return t=i.indexOf("-"),t>-1?this.eval(i.substring(0,t))-this.eval(i.substring(t+1)):(t=i.indexOf("+"),t>-1?this.eval(i.substring(0,t))+this.eval(i.substring(t+1)):(t=i.indexOf("/"),t>-1?this.eval(i.substring(0,t))/this.eval(i.substring(t+1)):(t=i.indexOf("*"),t>-1?this.eval(i.substring(0,t))*this.eval(i.substring(t+1)):i)))}},iio.set=function(i,t){for(var e=0;e<i.length;e++)i[e].set(t)},set=function(i,t){if(i instanceof Array)for(var e=0;e<i.length;e++)this.set(i[e],t);else if(iio.isNumber(i))this.radius?this.radius=i/2:this.width=this.width==this.height?this.height=i:i;else if(iio.isString(i))iio.run(i.split(" "),this,!0);else for(var s in i)this[s]=i[s];if(this.text&&(this.type=iio.TEXT),this.simple&&(this.bbx instanceof Array?this.bbx[1]=this.bbx[0]:this.bbx=[this.bbx,this.bbx]),this.anims&&(this.animKey=0,this.animFrame=0,this.width||(this.width=this.anims[this.animKey].frames[this.animFrame].w),this.height||(this.height=this.anims[this.animKey].frames[this.animFrame].h)),this.bezier)for(var e=0;e<this.bezier.length;e++)"n"==this.bezier[e]&&(this.bezier[e]=void 0);if(this.img&&iio.isString(this.img)){t=!1;var o=this.img;this.img=new Image,this.img.src=o,this.img.parent=this,("undefined"==typeof this.width&&"undefined"==typeof this.radius||0==this.radius)&&(this.img.onload=function(){0==this.parent.radius?this.parent.radius=this.width/2:(this.parent.width=this.width||0,this.parent.height=this.height||0),t||this.parent.app.draw()})}else this.img&&("undefined"==typeof this.width&&"undefined"==typeof this.radius||0==this.radius)&&(0==this.radius?this.radius=this.img.width/2:(this.width=this.img.width||0,this.height=this.img.height||0),t||this.app.draw());return!(this.vel&&(0!=this.vel.x||0!=this.vel.y||0!=this.vel.r)||this.shrink||this.fade||this.acc&&(0!=this.acc.x||0!=this.acc.y||0!=this.acc.r))||"undefined"!=typeof this.app.looping&&this.app.looping!==!1||this.app.loop(),t||this.app.draw(),this},add=function(i,t,e,s){if(i instanceof Array&&!iio.isNumber(i[0])&&"undefined"==typeof i[0].x)for(var o=0;o<i.length;o++)this.add(i[o],t,e,s);else if("undefined"!=typeof i.type){i.parent=this,i.app=this.app,s=t,"undefined"==typeof i.z&&(i.z=0);for(var o=0;o<this.objs.length&&"undefined"!=typeof this.objs[o].z&&i.z>=this.objs[o].z;)o++;this.objs.insert(o,i)}else i=this.add(new iio.Obj(i,t,e,this),!0);return s||this.app.draw(),i},rmv=function(i,t){if("undefined"==typeof i)this.objs=[];else if(i instanceof Array)for(var e=0;e<i.length;e++)this.rmv(i[e]);else if(iio.isNumber(i)&&i<this.objs.length)this.objs.splice(i,1);else if(this.objs)for(var e=0;e<this.objs.length;e++)if(this.objs[e]==i){this.objs.splice(e,1);break}if(this.collisions)for(var e=0;e<this.collisions.length;e++){if(this.collisions[e][0]==i||this.collisions[e][1]==i)this.collisions.splice(e,1);else if(this.collisions[e][0]instanceof Array)for(var s=0;s<this.collisions[e][0].length;s++)if(this.collisions[e][0][s]==i){this.collisions[e][0].splice(s,1);break}if(this.collisions[e][1]instanceof Array)for(var s=0;s<this.collisions[e][1].length;s++)if(this.collisions[e][1][s]==i){this.collisions[e][1].splice(s,1);break}}return t||this.app.draw(),i},iio.addInputListeners=function(i){i.onmousedown=function(i){var t=this.parent.convertEventPos(i);this.parent.click&&this.parent.click(i,t);for(var e=0;e<this.parent.objs.length;e++)if(0!==e&&(t=this.parent.convertEventPos(i)),this.parent.objs[e].contains&&this.parent.objs[e].contains(t)&&this.parent.objs[e].click)if(this.parent.objs[e].type==iio.GRID){var s=this.parent.objs[e].cellAt(t);this.parent.objs[e].click(i,t,s,this.parent.objs[e].cellCenter(s.c,s.r))}else this.parent.objs[e].click(i,t)}},iio.addEvent(window,"keydown",function(i){for(var t=iio.getKeyString(i),e=0;e<iio.apps.length;e++)iio.apps[e].runScript&&iio.apps[e].runScript.onKeyDown&&iio.apps[e].runScript.onKeyDown(i,t)}),iio.addEvent(window,"keyup",function(i){for(var t=iio.getKeyString(i),e=0;e<iio.apps.length;e++)iio.apps[e].runScript&&iio.apps[e].runScript.onKeyUp&&iio.apps[e].runScript.onKeyUp(i,t)}),iio.addEvent(window,"scroll",function(){for(var i=0;i<iio.apps.length;i++){var t=iio.apps[i].canvas.getBoundingClientRect();iio.apps[i].pos={x:t.left,y:t.top}}}),iio.App=t,t.prototype.App=function(i,t,e){this.type=iio.APP,this.canvas=i,this.canvas.parent=this,iio.addInputListeners(this.canvas),this.ctx=i.getContext("2d"),this.width=i.clientWidth||i.width,this.height=i.clientHeight||i.height,this.center={x:this.width/2,y:this.height/2};var s=i.getBoundingClientRect();this.pos={x:s.left,y:s.top},this.convertEventPos=function(i){return{x:i.clientX-this.pos.x,y:i.clientY-this.pos.y}},this.init=init,this.init(),this.collisions=[],this.app=this,iio.apps.push(this),iio.isString(t)?(this.runScript=iio.run(t,this),this.draw()):this.runScript=new t(this,e)},t.prototype.stop=function(){for(var i=0;i<this.objs.length;i++)iio.cancelLoops(this.objs[i]);iio.cancelLoops(this),this.mainLoop&&iio.cancelLoop(this.mainLoop.id),this.clear()},t.prototype.draw=function(i){if(i||this.ctx.clearRect(0,0,this.width,this.height),this.color&&(this.ctx.fillStyle=this.color,this.ctx.fillRect(0,0,this.width,this.height)),this.round&&this.canvas.style.borderRadius!=this.round&&(this.canvas.style.borderRadius=this.round),this.outline&&(this.canvas.style.border=(this.lineWidth||1)+"px solid "+this.outline),this.alpha&&(this.canvas.style.opacity=this.alpha),this.objs.length>0)for(var t=0;t<this.objs.length;t++)this.objs[t].draw&&this.objs[t].draw(this.ctx)},t.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)},t.prototype.collision=function(i,t,e){this.collisions.push([i,t,e])},t.prototype.cCollisions=function(i,t,e){if(i instanceof Array)if(t instanceof Array){if(0==t.length)return;for(var s=0;s<i.length;s++)for(var o=0;o<t.length;o++)iio.checkCollision(i[s],t[o])&&e(i[s],t[o])}else for(var n=0;n<i.length;n++)iio.checkCollision(i[n],t)&&e(i[n],t);else if(t instanceof Array)for(var n=0;n<t.length;n++)iio.checkCollision(i,t[n])&&e(i,t[n]);else iio.checkCollision(i,t)&&e(i,t)},t.prototype._update=function(i,t){if(this.update&&this.update(t),this.objs&&this.objs.length>0)for(var e=0;e<this.objs.length;e++)this.objs[e]._update&&this.objs[e]._update(i,t)&&this.rmv(this.objs[e]);if(this.collisions&&this.collisions.length>0)for(var e=0;e<this.collisions.length;e++)this.cCollisions(this.collisions[e][0],this.collisions[e][1],this.collisions[e][2])},iio.checkCollision=function(i,t){return"undefined"==typeof i||"undefined"==typeof t?!1:i.type==iio.RECT&&t.type==iio.RECT?i.simple?t.simple?iio.rectXrect(i.pos.x-i.bbx[0],i.pos.x+i.bbx[0],i.pos.y-(i.bbx[1]||i.bbx[0]),i.pos.y+(i.bbx[1]||i.bbx[0]),t.pos.x-t.bbx[0],t.pos.x+t.bbx[0],t.pos.y-(t.bbx[1]||t.bbx[0]),t.pos.y+(t.bbx[1]||t.bbx[0])):iio.rectXrect(i.pos.x-i.bbx[0],i.pos.x+i.bbx[0],i.pos.y-(i.bbx[1]||i.bbx[0]),i.pos.y+(i.bbx[1]||i.bbx[0]),t.left,t.right,t.top,t.bottom):t.simple?iio.rectXrect(i.left,i.right,i.top,i.bottom,t.pos.x-t.bbx[0],t.pos.x+t.bbx[0],t.pos.y-(t.bbx[1]||t.bbx[0]),t.pos.y+(t.bbx[1]||t.bbx[0])):iio.rectXrect(i.left,i.right,i.top,i.bottom,t.left,t.right,t.top,t.bottom):void 0},iio.rectXrect=function(i,t,e,s,o,n,r,h){return n>i&&t>o&&h>e&&s>r?!0:!1},iio.SpriteMap=e,e.prototype.SpriteMap=function(i,t){return this.img=new Image,this.img.src=i,this.img.onload=t.onload,this},e.prototype.sprite=function(i,t,e,s,o,n){var r={};if(iio.isString(i)&&(r.tag=i,i=t,t=e,e=s,s=o,o=n),i instanceof Array)r.frames=i;else if(e instanceof Array)r.frames=e;else{r.frames=[],o=o||0,i=s;for(var h=0;e>h;h++)r.frames[h]={x:i*h,y:o,w:i,h:t}}for(var h=0;h<r.frames.length;h++)"undefined"==typeof r.frames[h].src&&(r.frames[h].src=this.img),"undefined"==typeof r.frames[h].w&&(r.frames[h].w=i),"undefined"==typeof r.frames[h].h&&(r.frames[h].h=t);return r},iio.Obj=s,s.prototype.Obj=function(i,t,e,s){if(this.init=init,this.init(),"undefined"==typeof s&&(s=e),s&&(this.parent=s,this.app=s.app),iio.isString(i)){var o=iio.parsePos(i.split(" "),this.parent);i=o.ps?o.ps:{x:0,y:0},e=t,t=o.p}i=iio.pointsToVecs(i),this.pos=i[0],2==i.length&&(this.type=iio.LINE),this.center={x:0,y:0},this.rot=0,this.vel={x:0,y:0,r:0},this.acc={x:0,y:0,r:0},t=[t,e],this.set(t,!0),i.length>2?(this.vs=i,iio.initPoly(this)):2==i.length?(this.endPos=i[1],iio.initLine(this)):(this.type==iio.TEXT?iio.initText(this):this.type==iio.CIRC?iio.initCirc(this):(iio.initRect(this),this.type==iio.GRID?iio.initGrid(this):this.type=iio.RECT),this.updateProps=function(){this.center=this.pos,this.left=this.pos.x-this.width/2,this.right=this.pos.x+this.width/2,this.top=this.pos.y-this.height/2,this.bottom=this.pos.y+this.height/2},this.updateProps()),"center"==this.origin&&(this.origin=this.center),this.clear=function(){this.objs=[],this.app.draw()},iio.resolveBounds=function(i,t){return i.length>1?i[1](t):!0},iio.upperBoundReached=function(i,t,e){return t>i[0]?iio.resolveBounds(i,e):!1},iio.lowerBoundReached=function(i,t,e){return t<i[0]?iio.resolveBounds(i,e):!1},this._shrink=function(i,t){return this.width*=1-i,this.height*=1-i,this.width<.02?t?t(this):!0:void 0},this._fade=function(i,t){return this.alpha*=1-i,this.alpha<.002?t?t(this):!0:void 0},this._update=function(i,t){this.update&&this.update(t);var e=!1;if(this.bounds&&!this.simple?(this.bounds.right&&(e=iio.upperBoundReached(this.bounds.right,this.right,this)),this.bounds.left&&(e=iio.lowerBoundReached(this.bounds.left,this.left,this)),this.bounds.top&&(e=iio.lowerBoundReached(this.bounds.top,this.top,this)),this.bounds.bottom&&(e=iio.upperBoundReached(this.bounds.bottom,this.bottom,this))):this.bounds&&(this.bounds.right&&(e=iio.upperBoundReached(this.bounds.right,this.pos.x,this)),this.bounds.left&&(e=iio.lowerBoundReached(this.bounds.left,this.pos.x,this)),this.bounds.top&&(e=iio.lowerBoundReached(this.bounds.top,this.pos.y,this)),this.bounds.bottom&&(e=iio.upperBoundReached(this.bounds.bottom,this.pos.y,this))),this.shrink&&(e=this.shrink instanceof Array?this._shrink(this.shrink[0],this.shrink[1]):this._shrink(this.shrink)),this.fade&&(e=this.fade instanceof Array?this._fade(this.fade[0],this.fade[1]):this._fade(this.fade)),e)return e;if(this.vel.x+=this.acc.x,this.vel.y+=this.acc.y,this.vel.r+=this.acc.r,this.vel.x&&(this.pos.x+=this.vel.x),this.vel.y&&(this.pos.y+=this.vel.y),this.vel.r&&(this.rot+=this.vel.r),this.simple||this.updateProps(this.vel),this.objs&&this.objs.length>0)for(var s=0;s<this.objs.length;s++)this.objs[s]._update&&this.objs[s]._update(i,t)&&this.rmv(this.objs[s])},this.draw=function(i){if(!this.hidden){if("undefined"==typeof i&&(i=this.app.ctx),i.save(),this.origin?i.translate(this.origin.x,this.origin.y):i.translate(this.pos.x,this.pos.y),0!=this.rot&&i.rotate(this.rot),this.objs.length>0){for(var t=!1,e=0;e<this.objs.length;e++)!t&&this.objs[e].z>=this.z&&(this.__draw(i),t=!0),this.objs[e].draw&&this.objs[e].draw(i);t||this.__draw(i)}else this.__draw(i);i.restore()}},this.__draw=function(i){if(i.save(),i.globalAlpha=this.alpha,this.lineCap&&(i.lineCap=this.lineCap),this.shadow)for(var t=this.shadow.split(" "),e=0;e<t.length;e++)if(iio.isNumber(t[e]))i.shadowBlur=t[e];else if(t[e].indexOf(":")>-1){var s=t[e].indexOf(":");i.shadowOffsetX=t[e].substring(0,s),i.shadowOffsetY=t[e].substring(s+1)}else i.shadowColor=t[e];this.dash&&(this.dash.length>1&&this.dash.length%2==1&&(i.lineDashOffset=this.dash[this.dash.length-1]),i.setLineDash(this.dash)),this._draw(i),i.restore()},this.createGradient=function(i,t){var e,s=t.split(":"),o=s[1].split(",");e=4==o.length?i.createLinearGradient(this.eval(o[0]),this.eval(o[1]),this.eval(o[2]),this.eval(o[3])):i.createRadialGradient(this.eval(o[0]),this.eval(o[1]),this.eval(o[2]),this.eval(o[3]),this.eval(o[4]),this.eval(o[5]));for(var n,r=2;r<s.length;r++){n=s[r].indexOf(",");var h=parseFloat(s[r].substring(0,n)),a=this.eval(s[r].substring(n+1));e.addColorStop(h,a)}return e}},iio.prepShape=function(i,t){t.color&&(t.color.indexOf&&t.color.indexOf("gradient")>-1&&(t.color=t.createGradient(i,t.color)),i.fillStyle=t.color),t.outline&&(t.outline.indexOf&&t.outline.indexOf("gradient")>-1&&(t.outline=t.createGradient(i,t.outline)),i.lineWidth=t.lineWidth,i.strokeStyle=t.outline)},iio.finishPathShape=function(i,t){t.color&&i.fill(),t.img&&i.drawImage(t.img,-t.width/2,-t.height/2,t.width,t.height),t.outline&&i.stroke(),t.clip&&i.clip()},iio.prepX=function(i,t){i.save(),t.xColor.indexOf&&t.xColor.indexOf("gradient")>-1&&(t.xColor=t.createGradient(i,t.xColor)),i.strokeStyle=t.xColor,i.lineWidth=t.lineWidth},iio.initLine=function(i){i.center.x=(i.pos.x+i.endPos.x)/2,i.center.y=(i.pos.y+i.endPos.y)/2,i.width=iio.V.dist(i.pos,i.endPos),i.height=i.lineWidth,i._draw=function(t){i.color.indexOf&&i.color.indexOf("gradient")>-1&&(i.color=i.createGradient(t,i.color)),t.strokeStyle=this.color,t.lineWidth=this.lineWidth,this.origin?t.translate(-this.origin.x,-this.origin.y):t.translate(-this.pos.x,-this.pos.y),t.beginPath(),t.moveTo(this.pos.x,this.pos.y),this.bezier?t.bezierCurveTo(this.bezier[0],this.bezier[1],this.bezier[2],this.bezier[3],this.endPos.x,this.endPos.y):t.lineTo(this.endPos.x,this.endPos.y),t.stroke()},i.updateProps=function(i){this.endPos.x+=i.x,this.endPos.y+=i.y,this.center.x+=i.x,this.center.y+=i.y}},iio.initRect=function(i){i._draw=function(i){iio.prepShape(i,this),i.translate(-this.width/2,-this.height/2),this.bezier?(iio.drawPoly(i,this.getTrueVertices(),this.bezier),iio.finishPathShape(i,this)):iio.drawRect(i,this.width,this.height,{c:this.color,o:this.outline},{img:this.img,anims:this.anims,animKey:this.animKey,animFrame:this.animFrame,mov:this.mov,round:this.round}),this.xColor&&(iio.prepX(i,this),iio.drawLine(i,0,0,this.width,this.height),iio.drawLine(i,this.width,0,0,this.height),i.restore())},i.getTrueVertices=function(){this.vs=[{x:this.left,y:this.top},{x:this.right,y:this.top},{x:this.right,y:this.bottom},{x:this.left,y:this.bottom}];for(var i,t,e=[],s=0;s<this.vs.length;s++){i=this.vs[s].x-this.pos.x,t=this.vs[s].y-this.pos.y;var o=iio.rotatePoint(i,t,this.rot);o.x+=this.pos.x,o.y+=this.pos.y,e[s]=o}return e},i.contains=function(i,t){return this.rot?iio.polyContains(this,i,t):(t=i.y||t,i=i.x||i,i-=this.pos.x,t-=this.pos.y,i>-this.width/2&&i<this.width/2&&t>-this.height/2&&t<this.height/2?!0:!1)}},iio.initGrid=function(i){i.cells=[];for(var t=-i.res.x*(i.C-1)/2,e=-i.res.y*(i.R-1)/2,s=0;s<i.C;s++){i.cells[s]=[];for(var o=0;o<i.R;o++)i.cells[s][o]=i.add(new iio.Obj([t,e],{c:s,r:o,width:i.res.x,height:i.res.y},void 0,i)),e+=i.res.y;e=-i.res.y*(i.R-1)/2,t+=i.res.x}i.clear=function(){this.objs=[],iio.initGrid(this),this.app.draw()},i._draw=function(i){if(iio.prepShape(i,this),i.translate(-this.width/2,-this.height/2),iio.drawRect(i,this.width,this.height,{c:this.color,o:this.outline},{img:this.img,anims:this.anims,mov:this.mov,round:this.round}),this.gridColor){this.gridColor.indexOf&&this.gridColor.indexOf("gradient")>-1&&(this.gridColor=this.createGradient(i,this.gridColor)),i.strokeStyle=this.gridColor,i.lineWidth=this.lineWidth;for(var t=1;t<this.C;t++)iio.drawLine(i,t*this.res.x,0,t*this.res.x,this.height);for(var e=1;e<this.R;e++)iio.drawLine(i,0,e*this.res.y,this.width,e*this.res.y)}},i.cellCenter=function(i,t){return{x:-this.width/2+i*this.res.x+this.res.x/2,y:-this.height/2+t*this.res.y+this.res.y/2}},i.cellAt=function(i,t){return i.x?this.cells[Math.floor((i.x-this.left)/this.res.x)][Math.floor((i.y-this.top)/this.res.y)]:this.cells[Math.floor((i-this.left)/this.res.x)][Math.floor((t-this.top)/this.res.y)]},i.foreachCell=function(i,t){for(var e=!0,s=0;s<this.C;s++)for(var o=0;o<this.R;o++)if(e=i(this.cells[s][o],t),"undefined"!=typeof e&&!e)return[o,s]}},iio.initCirc=function(i){i.type=iio.CIRC,i.contains=function(i,t){return"undefined"!=typeof t&&(i={x:i,y:t}),this.width==this.height&&iio.V.dist(i,this.pos)<this.width/2?!0:(this.rot&&(i.x-=this.pos.x,i.y-=this.pos.y,i=iio.rotatePoint(i.x,i.y,-this.rot),i.x+=this.pos.x,i.y+=this.pos.y),Math.pow(i.x-this.pos.x,2)/Math.pow(this.width/2,2)+Math.pow(i.y-this.pos.y,2)/Math.pow(this.height/2,2)<=1?!0:!1)},i._draw=function(t){iio.prepShape(t,this),t.beginPath(),this.width!=this.height?(t.moveTo(0,-this.height/2),this.bezier?(t.bezierCurveTo(this.bezier[0]||this.width/2,this.bezier[1]||-this.height/2,this.bezier[2]||this.width/2,this.bezier[3]||this.height/2,0,this.height/2),t.bezierCurveTo(this.bezier[4]||-this.width/2,this.bezier[5]||this.height/2,this.bezier[6]||-this.width/2,this.bezier[7]||-this.height/2,0,-this.height/2)):(t.bezierCurveTo(this.width/2,-this.height/2,this.width/2,this.height/2,0,this.height/2),t.bezierCurveTo(-this.width/2,this.height/2,-this.width/2,-this.height/2,0,-this.height/2))):t.arc(0,0,this.width/2,0,2*Math.PI,!1),this.width!=this.height&&t.closePath(),iio.finishPathShape(t,this),this.xColor&&(t.rotate(Math.PI/4),iio.prepX(t,this),t.translate(0,-i.height/2),iio.drawLine(t,0,0,0,i.height),t.translate(0,i.height/2),iio.drawLine(t,i.width/2,0,-i.width/2,0),t.restore())}},iio.initPoly=function(i){i.type=iio.POLY,i.getTrueVertices=function(){for(var i,t,e=[],s=0;s<this.vs.length;s++){i=this.vs[s].x-this.pos.x,t=this.vs[s].y-this.pos.y;var o=iio.rotatePoint(i,t,this.rot);o.x+=this.pos.x,o.y+=this.pos.y,e[s]=o}return e},i._draw=function(i){iio.prepShape(i,this),iio.drawPoly(i,this.vs,this.bezier,this.open),iio.finishPathShape(i,this)},i.contains=function(i,t){return iio.polyContains(this,i,t)},i.updateProps=function(){this.center=this.pos}},iio.polyContains=function(i,t,e){e=t.y||e,t=t.x||t;var s=j=c=0,o=i.vs;for(i.rot&&(o=i.getTrueVertices()),s=0,j=o.length-1;s<o.length;j=s++)o[s].y>e!=o[j].y>e&&t<(o[j].x-o[s].x)*(e-o[s].y)/(o[j].y-o[s].y)+o[s].x&&(c=!c);return c},iio.drawPoly=function(i,t,e,s){if(i.beginPath(),i.moveTo(0,0),e){for(var o=0,n=1;n<t.length;n++)i.bezierCurveTo(e[o++]||t[n-1].x-t[0].x,e[o++]||t[n-1].y-t[0].y,e[o++]||t[n].x-t[0].x,e[o++]||t[n].y-t[0].y,t[n].x-t[0].x,t[n].y-t[0].y);"undefined"!=typeof s&&s||(n--,i.bezierCurveTo(e[o++]||t[n].x-t[0].x,e[o++]||t[n].y-t[0].y,e[o++]||0,e[o++]||0,0,0))}else for(var n=1;n<t.length;n++)i.lineTo(t[n].x-t[0].x,t[n].y-t[0].y);"undefined"!=typeof s&&s||i.closePath()},iio.drawRect=function(i,t,e,s,o){o.round?(i.beginPath(),i.moveTo(o.round[0],0),i.lineTo(t-o.round[1],0),i.quadraticCurveTo(t,0,t,o.round[1]),i.lineTo(t,e-o.round[2]),i.quadraticCurveTo(t,e,t-o.round[2],e),i.lineTo(o.round[3],e),i.quadraticCurveTo(0,e,0,e-o.round[3]),i.lineTo(0,o.round[0]),i.quadraticCurveTo(0,0,o.round[0],0),i.closePath(),i.stroke(),i.fill(),i.clip()):(s.c&&i.fillRect(0,0,t,e),o.img&&i.drawImage(o.img,0,0,t,e),o.anims&&i.drawImage(o.anims[o.animKey].frames[o.animFrame].src,o.anims[o.animKey].frames[o.animFrame].x,o.anims[o.animKey].frames[o.animFrame].y,o.anims[o.animKey].frames[o.animFrame].w,o.anims[o.animKey].frames[o.animFrame].h,0,0,t,e),s.o&&i.strokeRect(0,0,t,e))},iio.drawLine=function(i,t,e,s,o){i.beginPath(),i.moveTo(t,e),i.lineTo(s,o),i.stroke()},iio.initText=function(i){i.size=i.width,i.app.ctx.font=i.size+"px "+i.font,i.width=i.app.ctx.measureText(i.text).width,i.height=i.app.ctx.measureText("W").width,i._draw=function(i){i.font=this.size+"px "+this.font,i.textAlign=this.align,iio.prepShape(i,this),this.color&&i.fillText(this.text,0,0),this.outline&&i.strokeText(this.text,0,0),this.showCursor&&(this.cursor.pos.x=this.cursor.endPos.x=this.getX(this.cursor.index))},i.contains=function(i,t){return"undefined"==typeof t&&(t=i.y,i=i.x),i-=this.pos.x,t-=this.pos.y,("undefined"==typeof this.align||"left"==this.align)&&i>0&&i<this.width&&0>t&&t>-this.height?!0:"center"==this.align&&i>-this.width/2&&i<this.width/2&&0>t&&t>-this.height?!0:("right"==this.align||"end"==this.align)&&i>-this.width&&0>i&&0>t&&t>-this.height?!0:!1},i.charWidth=function(i){return i=i||0,this.app.ctx.font=this.size+"px "+this.font,this.app.ctx.measureText(this.text.charAt(i)).width},i.getX=function(i){if(this.app.ctx.font=this.size+"px "+this.font,"undefined"==typeof this.align||"left"==this.align)return this.app.ctx.measureText(this.text.substring(0,i)).width;if("right"==this.align||"end"==this.align)return-this.app.ctx.measureText(this.text.substring(0,this.text.length-i)).width;if("center"==this.align){var t=-Math.floor(this.app.ctx.measureText(this.text).width/2);return t+this.app.ctx.measureText(this.text.substring(0,i)).width}};var t=i.getX(i.text.length);i.cursor=i.add([t,10,t,.8*-i.size],"2 "+(i.color||i.outline),{index:i.text.length,shift:!1}),i.showCursor?i.loop(2,function(i){i.cursor.hidden=!i.cursor.hidden}):i.cursor.hidden=!0,i.keyUp=function(i){"shift"==i&&(this.cursor.shift=!1)},i.keyDown=function(i,t,e,s){iio.isNumber(t)||(s=t,t=this.cursor.index);var o,n=this.text.substring(0,t),r=this.text.substring(t);return"undefined"!=typeof s&&(o=s(i,e,n,r),0!=o)?(this.text=n+o+r,this.cursor.index=t+1,this.showCursor&&(this.cursor.hidden=!1),this.app.draw(),this.cursor.index):(i.length>1?"space"==i?(this.text=n+" "+r,t++):"backspace"==i&&t>0?(this.text=n.substring(0,n.length-1)+r,t--):"delete"==i&&t<this.text.length?this.text=n+r.substring(1):"left arrow"==i&&t>0?t--:"right arrow"==i&&t<this.text.length?t++:"shift"==i?this.cursor.shift=!0:"semi-colon"==i?(this.text=e?n+":"+r:n+";"+r,t++):"equal"==i?(this.text=e?n+"+"+r:n+"="+r,t++):"comma"==i?(this.text=e?n+"<"+r:n+","+r,t++):"dash"==i?(this.text=e?n+"_"+r:n+"-"+r,t++):"period"==i?(this.text=e?n+">"+r:n+"."+r,t++):"forward slash"==i?(this.text=e?n+"?"+r:n+"/"+r,t++):"grave accent"==i?(this.text=e?n+"~"+r:n+"`"+r,t++):"open bracket"==i?(this.text=e?n+"{"+r:n+"["+r,t++):"back slash"==i?(this.text=e?n+"|"+r:n+"/"+r,t++):"close bracket"==i?(this.text=e?n+"}"+r:n+"]"+r,t++):"single quote"==i&&(this.text=e?n+'"'+r:n+"'"+r,t++):(this.text=e||this.cursor.shift?n+i.charAt(0).toUpperCase()+r:n+i+r,t++),this.showCursor&&(this.cursor.hidden=!1),this.cursor.index=t,this.app.draw(),t)}},iio.V={},iio.V.add=function(i,t){for(var e in t)i[e]&&(i[e]+=t[e]);return i},iio.V.sub=function(i,t){for(var e in t)i[e]&&(i[e]-=t[e]);return i},iio.V.mult=function(i,t){for(var e in t)i[e]&&(i[e]*=t[e]);return i},iio.V.div=function(i,t){for(var e in t)i[e]&&(i[e]/=t[e]);return i},iio.V.dist=function(i,t){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}}();